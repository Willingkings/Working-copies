<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>订单支付</title>
    <link rel="stylesheet" href="../lib/layui/css/layui.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/orderPay.css">
</head>
<body style="height: 100%;">
    <div id="loading"></div>
    <img class="loading" src="../image/loading.gif" alt="">
    <div class="mainBox orderTop">
        <span class="orderTitle" id="orderTitle"></span>
        <span class="orderPrice price">￥<i id="price"></i></span>
        <div>
            <span>收款人</span>
            <span>桂林出行网</span>
        </div>
    </div>
    <div class="mainBox MethodPay">
        <span><img src="../image/wxzf.png"></span>
        <span>微信支付</span>
        <span><img src="../image/ic_xuanzhong.png"></span>
    </div>
    <div class="submitBut" id="submitBut">确认支付</div>



<script src="../lib/jquery.min.js"></script>
<script src="../lib/md5.js"></script>
<script src="../lib/layui/layui.js"></script>
<script src="../js/global.js"></script>
<script>
    (function($, undefined) {
        var productDetails = {
            memberInfo: {},
            state: JSON.parse(decodeURIComponent(mainFun.GetQueryString("state"))),
            userinfo: JSON.parse(decodeURIComponent(mainFun.GetQueryString("userinfo"))),
            init: function () {
                layui.use('layer', function(){
                    var layer = layui.layer;
                });
                this.getOpenId();
                this.getProductDetails();
                this.immediatePay();
            },
            // 获取memberId 、userId 、openId
            getOpenId: function (){
                let _this = this;

                _this.memberInfo.openId = _this.userinfo.openId;
                _this.memberInfo.memberId = _this.userinfo.memberId;
                _this.memberInfo.userId = _this.userinfo.phoneNum;
                _this.memberInfo.shortMessage = _this.userinfo.shortMessage;
                $("#loading").hide();
                $(".loading").hide();

//                let code = mainFun.GetQueryString("code");
//                let datetime = mainFun.currentTime("yymmddhhmmss");
//                if (code) {
//                    $.ajax({
//                        url: 'http://api.member.glchuxingwang.com/smallRoutine/getOpenID',
//                        // url: 'http://test.api.member.glchuxingwang.com/smallRoutine/getOpenID',
//                        dataType: 'json',
//                        type: 'get',
//                        data: {
//                            js_code: code,
//                            datetime: datetime,
//                            sign: hex_md5('key=gldy2017@ugiant2017@!~#*' + '&datetime=' + datetime),
//                            type: "2"
//                        },
//                        success: function (data){
//                            $("#loading").hide();
//                            $(".loading").hide();
//                            if (data.success) {
//                                _this.memberInfo.openId = data.openID;
//                                _this.memberInfo.memberId = data.memberID;
//                                _this.memberInfo.userId = data.mobileNo;
//                            }else {
//                                _this.memberInfo.memberId = null
//                            }
//                        }
//                    });
//                }
            },
            // 获取商品价格
            getProductDetails: function(){
                var _this = this;
                var lineCode = _this.state.lineCode;
                $.ajax({
                    url: 'http://sec.api.cusbus.glchuxingwang.com/vl/cusbus/app/services/lineDetail',
                    dataType: 'json',
                    type: 'get',
                    data: {
                        token: "",
                        lineCode: lineCode
                    },
                    success: function (response){
                        let data = response.data;
                        var Data = response.data;
                        $("#orderTitle").text(data.stationInfo[0].name + "-" + data.stationInfo[data.stationInfo.length -1].name);
                        $("#price").text(data.stationInfo[0].stepPrice);
                        _this.memberInfo.price = data.stationInfo[0].stepPrice;
                        $.ajax({
                            url:'http://api.cusbus.glchuxingwang.com/vl/cusbus/app/services/firstPageRecommendAll',
                            type:'post',
                            dataType:'json',
                            data:{
                                lng: 110.319725,
                                lat: 25.277453,
                                token: "",
                            },
                            success:function(data){
                                var data = data.data;
                                for(var i = 0; i < data.length; i++) {
                                    if(data[i].lineCode == Data.lineCode) {
                                        console.log(data[i].lineName);
                                        $("#orderTitle").text(data[i].lineName);
                                    }
                                }
                            },
                            error:function(){
                                console.log('请求失败了');
                            }
                        })
                    }
                })
            },
            // 发送二维码短信
            sendCodeMessages: function (mobileNo,state){
                $.ajax({
                    url: 'http://test.api.member.glchuxingwang.com/common/sms/send_test',
                    dataType: 'json',
                    type: 'get',
                    data: {
                        mobileNo: mobileNo,
                        state: state,
                        type: 8,
                        version: 1,
                        platform: 1,
                        sign: hex_md5(hex_md5(mobileNo + "glcxw2017@ugiant2017@!~#*"))
                    },
                    success: function (response){
                        layer.msg(response.msg,{time:2000});
                    }
                })
            },
            // 支付
            immediatePay: function () {
                var _this = this;
                $("#submitBut").on("click",function () {
                    if (_this.memberInfo.length !== 0) {
                        $.ajax({
                            // url: 'http://test.api.cusbus.glchuxingwang.com/cusbus/app/services/ticketpay',
                            url: 'http://api.cusbus.glchuxingwang.com/cusbus/app/services/ticketpay',
                            dataType: 'json',
                            type: 'post',
                            data: {
                                userId: _this.memberInfo.userId,
                                memberId: _this.memberInfo.memberId,
                                flowNo: _this.state.flowNo,
                                paymentMoney: _this.state.price,
                                paymentTerminal: "20",
                                paymentMethod: "62",
                                openId: _this.memberInfo.openId
                            },
                            success: function (res){
                                if (res.success) {
                                    function onBridgeReady(){
                                        var payInfo = JSON.parse(res.data.wechat);
                                        WeixinJSBridge.invoke('getBrandWCPayRequest',{
                                                "appId" : payInfo.appId, //公众号名称，由商户传入
                                                "timeStamp": payInfo.timeStamp, //戳，自1970 年以来的秒数
                                                "nonceStr" : payInfo.nonceStr, //随机串
                                                "package" : payInfo.package,
                                                "signType" : payInfo.signType, //微信签名方式:
                                                "paySign" : payInfo.paySign  //微信签名,
                                            },
                                            function(res) {
                                                if (res.err_msg == "get_brand_wcpay_request:ok") {
                                                    _this.state.userId = _this.memberInfo.userId;
                                                    _this.state.flag = true;
                                                    productDetails.state.flag = false;
                                                    productDetails.sendCodeMessages(_this.memberInfo.shortMessage,encodeURIComponent(JSON.stringify(productDetails.state)));
                                                    window.location.href = "http://wechat.payment.glchuxingwang.com/wechatpay/ticketDetails.html?state="+ encodeURIComponent(JSON.stringify(_this.state));
                                                }
                                            });
                                    }
                                    if (typeof WeixinJSBridge == "undefined") {
                                        if (document.addEventListener) {
                                            document.addEventListener('WeixinJSBridgeReady',onBridgeReady,false);
                                        } else if (document.attachEvent) {
                                            document.attachEvent('WeixinJSBridgeReady',onBridgeReady);
                                            document.attachEvent('onWeixinJSBridgeReady',onBridgeReady);
                                        }
                                    } else {
                                        onBridgeReady();
                                    }
                                }
                            }
                        })
                    }
                })
            }
        };
        productDetails.init();
    })(jQuery)
</script>
</body>
</html>